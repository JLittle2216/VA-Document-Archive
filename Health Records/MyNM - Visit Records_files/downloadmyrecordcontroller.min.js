$$WPUtil.guaranteeExistence($$WP,"Documents.DownloadMyRecordController");$$WP.Documents.DownloadMyRecordController=function Epic$PatientAccess$Controllers$DownloadMyRecordController(f,g){var c="viewmode",b="hidden",e="#vdtdownloadbutton",d="#vdtpreviewbutton",a=this;a.Controllers$Controller();$afe.select(d).click(a,a.clickPreview);$afe.select(e).click(a,a.clickDownload);a.isLucySummaryEnabled=g;if(!f){a.getSingleVisits(a,0,false);a.setVisualDefaults([]);$afe.select("div.recordModeView[data-viewmode=lucySummaryView]").removeClass(b);$afe.select(e).removeClass(b);$afe.select(d).removeClass(b);return false}a.isPreviewEnabled=true;a.getSingleVisits(a,a._initialVisits,true);$afe.select(".downloadfailremove").click(function(){$afe.select(".downloadfail").addClass(b)});$afe.select("#vdtsendbutton").click(a,a.clickSend);$afe.select("a[name=recordMode]").click(a,a.updateView);$afe.select("#findVisits").click(a,a.getDateRangeVisits);a._singleViewElement=$afe.select("div").data(c)==="singleVisitView";a._dateRangeViewElement=$afe.select("div").data(c)==="dataRangeView";a._allViewElement=$afe.select("div").data(c)==="allVisitsView";a._allVisitsTextElement=document.getElementById("allVisitsText");a._dateRangeTextElement=document.getElementById("dateRangeText");a._startDateEntryElement=document.getElementById("datechooserFrom");a._endDateEntryElement=document.getElementById("datechooserTo");a._singleVisitsFromInst=$afe.select("#SingleVisitsFromInst").val();$$WPUtil.ShowAjaxSpinner($afe.select(".ajaxspinner"));$afe.select("#dateRangeAjaxSpinner").safeAppend($afe.renderTemplate($$WP.Templates.UI.AjaxSpinner,{inline:1}));$afe.select("#allVisitsText").safeAppend($afe.renderTemplate($$WP.Templates.UI.AjaxSpinner,{inline:1}))};$$WP.Documents.DownloadMyRecordController.prototype={isSendViaEmailEnabled:false,isFindProviderEnabled:false,isSendViaDirectEnabled:false,isLucySummaryEnabled:false,isPreviewEnabled:false,isDownloadEnabled:false,isVDTDownloadPasswordEnabled:false,isVDTDownloadPasswordForced:false,maxNumEncountersForDownload:-1,_activeView:"singleVisitView",_singleViewElement:null,_dateRangeViewElement:null,_allVisitsTextElement:null,_dateRangeTextElement:null,_startDateEntryElement:null,_endDateEntryElement:null,_allViewElement:null,_singleVisits:[],_singleVisitsEndDAT:null,_singleVisitsFromInst:null,_selectedSingleVisit:null,_startDate:null,_endDate:null,_dateRangeCount:null,_dateRangeVisits:null,_allVisits:null,_allVisitsCount:null,_allVisitsStartDate:null,_allVisitsEndDate:null,_pagingCurrentPage:null,_pagingNumPages:null,_pagingNumPerPage:null,_pagingInitialPages:5,_canLoadMorePages:true,_dateRangeInvalid:false,_nextRowId:0,_selectedVisitIndex:null,_visitsPerAddition:20,_visitsPerPage:10,_initialVisits:50,_loadAllVisitsCount:99999,_patientID:"",_isLoadingVisits:false,_maxEncsForTransmit:-1,updateView:function WP$Documents$DownloadMyRecordController$updateView(f){var m="withCalendar",l="Images/calendar.svg",k=null,c="disabled",h=".formbuttons input",d="#vdtdownloadbutton",j="#vdtpreviewbutton",b="hidden",i="#vdtsendbutton",g=false,a,e;a=f.data||this;e=f.currentTarget.getAttribute("data-value");$.proxy(showTabbedSection,this)();if(e===undefined)e=f.currentTarget.children[0].value;if(e===a._activeView)return g;$$WPUtil.HideAjaxSpinner($afe.select(".ajaxspinner"));changeErrorField("maxlimiterror","");changeErrorField("maxtransmitlimiterror","");switch(e){case"singleVisitView":$afe.select(i).removeClass(b);$afe.select(j).removeClass(b);if(a.isDownloadEnabled)$afe.select(d).removeClass(b);else{$afe.select(d).removeClass(b);$afe.select(d).addClass(b)}$afe.select(h).removeAttr(c).prop(c,g);break;case"dateRangeView":$afe.select(".datechooserAnchor").remove();if(a._dateRangeVisits===k){a.setDateDefaults();a.getDateRangeVisits(f)}$afe.select(i).removeClass(b);$afe.select(j).removeClass(b);if(a.isDownloadEnabled)$afe.select(d).removeClass(b);else{$afe.select(d).removeClass(b);$afe.select(d).addClass(b)}a._dateRangeInvalid&&$afe.select(h).safeAttr(c,c);writeCalendar("datechooserFrom","range",makeStaticLink(l));writeCalendar("datechooserTo","range",makeStaticLink(l));$afe.select("#datechooserFrom").addClass(m);$afe.select("#datechooserTo").addClass(m);a._dateRangeVisits!==k&&!a._dateRangeInvalid&&a.updateDateRangeTable(f.data._startDate,f.data._endDate);break;case"allVisitsView":if(a._allVisits===k)a.getAllVisits(a);else a.updateAllVisitsText();$afe.select(i).removeClass(b);$afe.select(j).removeClass(b);if(a.isDownloadEnabled)$afe.select(d).removeClass(b);else{$afe.select(d).removeClass(b);$afe.select(d).addClass(b)}if(a._allVisitsCount===k){$afe.select(h).removeAttr(c).prop(c,g);$afe.select(h).safeAttr(c,c)}else if(!isNaN(a.maxNumEncountersForDownload))(a.maxNumEncountersForDownload<0||a.maxNumEncountersForDownload>a._allVisitsCount)&&$afe.select(d).removeAttr(c).prop(c,g);break;case"lucySummaryView":$afe.select(i).addClass(b);$afe.select(j).removeClass(b);$afe.select(d).removeClass(b);$afe.select(h).removeAttr(c).prop(c,g)}a._activeView=e},updateDateRangeTable:function WP$Documents$DownloadMyRecordController$updateDateRangeTable(o,p){var h="#vdtsendbutton",l="@MYCHART@MAXENCSTRANSMIT@",d=false,b="disabled",g="#vdtdownloadbutton",k="@MYCHART@MAXENCS@",j="#dateRangeList",c="documents.downloadmyrecord",a=this,n,f,e;if(a._dateRangeTextElement===null){a._dateRangeTextElement=document.getElementById("dateRangeText");if(a._dateRangeTextElement===null)return}$$WP.Strings.setDefaultNamespace(c);$$WP.Strings.setDisplayText(a._dateRangeTextElement,"LoadingMessage");$$WP.Strings.addMnemonic("@MYCHART@STARTDATE@",o);$$WP.Strings.addMnemonic("@MYCHART@ENDDATE@",p);if(a._dateRangeCount===0){if(a._startDate===""){var m=$afe.jq(document.createElement("span"));$$WP.Strings.setDisplayText(m,"DateRangeNoResultsNoStartDateText",c);$afe.jq(a._dateRangeTextElement).safeAppend(m);var i=$afe.jq(document.createElement("span"));$$WP.Strings.setDisplayText(i,"GenericAccessLucySummaryText",c);$afe.jq(a._dateRangeTextElement).safeAppend($afe.jq(document.createElement("br")));$afe.jq(a._dateRangeTextElement).safeAppend(i)}else $$WP.Strings.setDisplayText(a._dateRangeTextElement,"DateRangeNoResultsFoundText",c);a._dateRangeTextElement.className="notice";$afe.select(j).addClass("hidden")}else{$$WP.Strings.setDisplayText(a._dateRangeTextElement,"DateRangeResultsFoundText");a._dateRangeTextElement.className="";$afe.select(j).removeClass("hidden")}if(a._dateRangeVisits.length>0){f={};f.DateRangeVisits=a._dateRangeVisits;a.formatVisitDescription(f.DateRangeVisits);n=$afe.renderTemplate($$WP.Templates.Documents.DateRangeList,f);$afe.select("#dateRangeList ul").safeReplaceWith(n);e=parseInt(a.maxNumEncountersForDownload);if(!isNaN(e)&&e>0&&e<a._dateRangeCount){$$WP.Strings.addMnemonic(k,a.maxNumEncountersForDownload);changeErrorField("maxlimiterror",$$WP.Strings.get("DownloadMaxEncounterErrorForDateRange",c));$$WP.Strings.removeMnemonic(k);$afe.select(g).removeAttr(b).prop(b,d);$afe.select(g).safeAttr(b,b)}else $afe.select(g).removeAttr(b).prop(b,d);if(a._maxEncsForTransmit>=0&&a._maxEncsForTransmit<a._dateRangeCount){$$WP.Strings.addMnemonic(l,a._maxEncsForTransmit);changeErrorField("maxtransmitlimiterror",$$WP.Strings.get("TransmitMaxEncounterErrorForDateRange",c));$$WP.Strings.removeMnemonic(l);$afe.select(h).removeAttr(b).prop(b,d);$afe.select(h).safeAttr(b,b)}else $afe.select(h).removeAttr(b).prop(b,d)}$$WP.Strings.clearDefaultNamespace()},updateAllVisitsText:function WP$Documents$DownloadMyRecordController$updateAllVisitsText(){var i="#vdtsendbutton",h="@MYCHART@MAXENCSTRANSMIT@",g="#vdtdownloadbutton",f="@MYCHART@MAXENCS@",b="disabled",d="documents.downloadmyrecord",a=this,c,j,e;c=a._allVisitsTextElement;if(c===null)c=document.getElementById("allVisitsText");$$WP.Strings.setDefaultNamespace(d);$$WP.Strings.addMnemonic("@MYCHART@STARTDATE@",a._allVisitsStartDate);$$WP.Strings.addMnemonic("@MYCHART@ENDDATE@",formatDate(new Date));if(a._allVisitsCount>0){$$WP.Strings.setDisplayText(c,"AllVisitsResultsFoundText",d);e={};e.DateRangeVisits=a._allVisits;a.formatVisitDescription(e.DateRangeVisits);j=$afe.renderTemplate($$WP.Templates.Documents.DateRangeList,e);$afe.select("#allVisitsList ul").safeReplaceWith(j);$afe.select(".formbuttons input").removeAttr(b).prop(b,false);maxEncs=parseInt(a.maxNumEncountersForDownload);if(!isNaN(maxEncs)&&maxEncs>0&&maxEncs<a._allVisitsCount){$$WP.Strings.addMnemonic(f,a.maxNumEncountersForDownload);changeErrorField("maxlimiterror",$$WP.Strings.get("DownloadMaxEncounterErrorForAllVisits",d));$$WP.Strings.removeMnemonic(f);$afe.select(g).safeAttr(b,b)}else $afe.select(g).removeAttr(b,b).prop(b,false);if(a._maxEncsForTransmit>=0&&a._maxEncsForTransmit<a._allVisitsCount){$$WP.Strings.addMnemonic(h,a._maxEncsForTransmit);changeErrorField("maxtransmitlimiterror",$$WP.Strings.get("TransmitMaxEncounterErrorForAllVisits",d));$$WP.Strings.removeMnemonic(h);$afe.select(i).safeAttr(b,b)}else $afe.select(i).removeAttr(b).prop(b,false)}$$WP.Strings.clearDefaultNamespace()},setDateDefaults:function WP$Documents$DownloadMyRecordController$setDateDefaults(){var a=this;if(!a._endDateEntryElement||!a._startDateEntryElement)return false;var b;b=new Date;a._endDateEntryElement.value=formatDate(b);b.setMonth(b.getMonth()-3);a._startDateEntryElement.value=formatDate(b);a.updateUserDates()},setVisitDefault:function WP$Documents$DownloadMyRecordController$setVisitDefault(d){var b="selectedVisitRecord",a,c;c=d.data||this;a=$afe.select("#visitRecords tr:not(.hidden) input[name=selectVisit]:radio")[0];if(a!==undefined){a.checked=true;$afe.select(".selectedVisitRecord").removeClass(b);var e=$afe.jq(a).parent().parent();e.addClass(b);c._selectedVisitIndex=a.getAttribute("data-index")}},setVisualDefaults:function WP$Documents$DownloadMyRecordController$setVisualDefaults(j,r){var q=".innertabs .ajaxspinner",p="[data-value='",e="selected",o=".membertab.selected",d="']",n="[data-viewmode='",m="withCalendar",l="Images/calendar.svg",h="#vdtpreviewbutton",g="#vdtdownloadbutton",f="#vdtsendbutton",k="lucySummaryView",b="hidden",c="body",a=this,i;if(!j)return false;a.setDateDefaults();if(j.length<=0){$afe.select(c).find(".recordModeView.section").addClass(b);if(a.isLucySummaryEnabled){a._activeView=k;$afe.select(f).addClass(b);$afe.select(g).removeClass(b);$afe.select(h).removeClass(b)}else{a._activeView="dateRangeView";$afe.select(f).removeClass(b);$afe.select(g).removeClass(b);$afe.select(h).removeClass(b);if(i!==undefined){i.data=a;a.getDateRangeVisits(i)}else a.getDateRangeVisits(a);writeCalendar("datechooserFrom","range",makeStaticLink(l));writeCalendar("datechooserTo","range",makeStaticLink(l));$afe.select("#datechooserFrom").addClass(m);$afe.select("#datechooserTo").addClass(m)}$afe.select(c).find(n+a._activeView+d).removeClass(b);$afe.select(c).find(o).removeClass(e);$afe.select(c).find(p+a._activeView+d).parent().addClass(e);$afe.select(c).find("[data-value='singleVisitView'], [data-value='allVisitsView']").parent().addClass(b);$$WPUtil.HideAjaxSpinner($afe.select(q));$afe.select("div.innertabs").show();return false}$afe.select(c).find(n+a._activeView+d).removeClass(b);$afe.select(c).find(o).removeClass(e);$afe.select(c).find(p+a._activeView+d).parent().addClass(e);a._activeView!==k&&$afe.select(f).removeClass(b);$afe.select(h).removeClass(b);r&&$afe.select(g).removeClass(b);a.createVisitRecordRows(j);a.initializePagination(a);a.setVisitDefault(a);$$WPUtil.HideAjaxSpinner($afe.select(q));$afe.select(".innertabs").removeClass(b)},getSingleVisits:function WP$Documents$VisitsRecordsController$getSingleVisits(a,c,h){var e=".ajaxspinner",d=".innertabs",b=false,g,f;g=a._singleVisitsEndDAT;if(c!==0&&(!c||isNaN(c)))c=a._visitsPerAddition;f=a._singleVisitsFromInst;if(a._isLoadingVisits)return b;a._isLoadingVisits=true;$$WPUtil.ShowAjaxSpinner($afe.select(d).find(e));$.ajax({type:"POST",url:makeLink("Documents/DownloadMyRecord/LoadSingleVisitsJson"),data:{EndDat:g,Count:c,FromInst:f},dataType:"json",success:function(f){$$WPUtil.HideAjaxSpinner($afe.select(d).find(e));if(a.ContainsException(f)){f.Value=$$WP.Strings.get(f.Value,"documents.downloadmyrecord");a.ShowErrorPopup(f);return b}a._singleVisits=a._singleVisits.concat(f.Visits);a._singleVisitsEndDAT=f.EndDate;a._singleVisitsFromInst=f.FromInst;a._patientID=f.EptID;a._maxEncsForTransmit=f.maxEncsForTransmit;a._isLoadingVisits=b;if(h){a.setVisualDefaults(f.Visits,a.isDownloadEnabled);return b}if(c===a._loadAllVisitsCount){a._canLoadMorePages=b;a.updatePaging(f.Visits,true);a.setVisitDefault(a)}else c>0&&a.updatePaging(f.Visits)}})},getDateRangeVisits:function WP$Documents$DownloadMyRecordController$getDateRangeVisits(h){var g="#dateRangeText",f="#dateRangeList",b="disabled",e=".formbuttons input",d=".ajaxspinner",c="#dateRangeAjaxSpinner",a=h.data||this;if(a.dateRangeValidatorAndErrorHandler(a._startDateEntryElement.value,a._endDateEntryElement.value)){$$WPUtil.ShowAjaxSpinner($afe.select(c).find(d));$afe.select(e).safeAttr(b,b);$afe.select(f).hide();$afe.select(g).hide();a.updateUserDates();$.ajax({type:"POST",url:makeLink("Documents/DownloadMyRecord/LoadDateRangeJson"),data:{StartDate:a._startDate,EndDate:a._endDate},dataType:"json",success:function(h){$$WPUtil.HideAjaxSpinner($afe.select(c).find(d));$afe.select(e).removeAttr(b).prop(b,false);$afe.select(g).show();$afe.select(f).show();if(a.ContainsException(h)){$$WP.Strings.setDisplayText(this._dateRangeTextElement,h.Value,"documents.downloadmyrecord");return false}a._dateRangeCount=h.VisitCount;a._dateRangeVisits=h.Visits;a._maxEncsForTransmit=h.maxEncsForTransmit;if(h.VisitCount>0){if(a._startDate==="")a._startDate=h.Visits[h.VisitCount-1].DateString;if(a._endDate==="")a._endDate=h.Visits[0].DateString}a.updateDateRangeTable(a._startDate,a._endDate)}})}},getAllVisits:function WP$Documents$DownloadMyRecordController$getAllVisits(a){var c=".ajaxspinner",b=".innertabs";if(a._allVisitsCount>0)return false;$$WPUtil.ShowAjaxSpinner($afe.select(b).find(c));$.ajax({type:"POST",url:makeLink("Documents/DownloadMyRecord/LoadAllVisitsJson"),dataType:"json",success:function(d){$$WPUtil.HideAjaxSpinner($afe.select(b).find(c));$afe.select("#allVisitsList").show();if(a.ContainsException(d)){$$WP.Strings.setDisplayText(a._allVisitsTextElement,d.Value,"documents.downloadmyrecord");return false}a._allVisitsCount=d.VisitCount;a._allVisitsStartDate=d.Visits[d.VisitCount-1].DateString;a._allVisits=d.Visits;a._maxEncsForTransmit=d.maxEncsForTransmit;a.updateAllVisitsText()}})},updateUserDates:function WP$Documents$DownloadMyRecordController$updateUserDates(){var a=this;a._startDate=a._startDateEntryElement.value;a._endDate=a._endDateEntryElement.value;if($$WPUtil.IsNullOrEmpty(a._endDate))a._endDate=formatDate(new Date)},getCsn:function WP$Documents$DownloadMyRecordController$getCsn(){var a=this._singleVisits[this._selectedVisitIndex];return a===undefined?"":a.Csn},getPatient:function WP$Documents$DownloadMyRecordController$getPatient(){return this._patientID},getSelectedVisit:function WP$Documents$DownloadmyRecordController$getSelectedVisit(){return this._singleVisits[this._selectedVisitIndex]},visitRowClick:function WP$Documents$DownloadMyRecordController$visitRowClick(e){var b="selectedVisitRecord",c,a;c=e.data||this;a=$afe.jq(e.currentTarget).find("input[name=selectVisit]");if(a.length===1){var d=$afe.select(".singlevisitrow").not(".hidden");d.each(function(a){$afe.jq(d[a]).removeClass(b)});$afe.jq(this).addClass(b);a[0].checked="checked";c._selectedVisitIndex=a[0].getAttribute("data-index")}},clickPreview:function WP$Documents$DownloadMyRecordController$clickPreview(u){var t="?docType=1&csn=&startDate=&endDate=",s="&endDate=",r="?docType=4&csn=&startDate=",q="@MYCHART@ENDDATE@",p="@MYCHART@STARTDATE@",n="&startDate=&endDate=",m="?docType=2&csn=",i=false,h=true,l="documents.downloadmyrecord",b,g,f,o,a,c,j,e,d,k;b=u.data||this;g={},f;o=$$WP.Strings.get("PreviewPopupTitleMulti",l);a={};c=makeLink("Documents/DownloadMyRecord/GetSingleVisitHTMLContent");e="&shSecQS="+b.getPatient();a.ShowMulti=h;a.ShowMoreThanLucy=h;a.ShowLucy=h;a.ShowMultiOrLucy=a.ShowMulti||a.ShowLucy;a.HasNoVisits=i;a.controller=b;g.Class="previewPopupMulti";g.SuppressTitle=h;g.TitleText="";g.BaseUrl=c;switch(b._activeView){case"singleVisitView":o=$$WP.Strings.get("PreviewPopupTitleSingle",l);a.ShowMulti=i;a.ShowMultiOrLucy=a.ShowMulti||a.ShowLucy;a.visitList=[];a.visitList[0]=b.getSelectedVisit();b.setupProvidersForPopup(a.visitList);if(!a.ShowLucy)a.altstartupsrc=c+m+a.visitList[0].Csn+n+e;else a.visitList[0].iframesrc=c+m+a.visitList[0].Csn+n+e;break;case"dateRangeView":a.visitList=b._dateRangeVisits;b.setupProvidersForPopup(a.visitList);a.startDate=b._startDate;a.endDate=b._endDate;if(a.visitList.length<1)a.HasNoVisits=h;$$WP.Strings.addMnemonic(p,a.startDate);$$WP.Strings.addMnemonic(q,a.endDate);a.MultiDateHeader=$$WP.Strings.getForTemplate("PreviewDateRangeText",l);$$WP.Strings.removeMnemonic(p);$$WP.Strings.removeMnemonic(q);if(!a.ShowLucy)a.altstartupsrc=c+r+a.startDate+s+a.endDate+e;else a.daterangeiframesrc=c+r+a.startDate+s+a.endDate+e;break;case"allVisitsView":a.visitList=b._allVisits;a.startDate=b._startDate;a.endDate=b._endDate;b.setupProvidersForPopup(a.visitList);if(a.visitList.length<1)a.HasNoVisits=h;a.MultiDateHeader=$$WP.Strings.get("PreviewAllVisitsText",l);a.daterangeiframesrc=c+"?docType=4&csn=&startDate=&endDate="+e;break;case"lucySummaryView":a.ShowMulti=i;a.ShowMoreThanLucy=i;a.visitList=[];a.visitList[0]={};a.visitList[0].iframesrc=c+t+e}d=new $$WP.Documents.DownloadMyRecord.PreviewPopupComponent(g);if(a.ShowLucy)a.lucyiframesrc=c+t+e;d.addEventListener("click",function(a){d.previewPopupClick(a)});d.addEventListener("keydown",function(a){d.previewPopupClick(a)});if(a.ShowMulti)for(j=0;j<a.visitList.length;j++)a.visitList[j].iframesrc=c+m+a.visitList[j].Csn+n+e;d.setData(a);f=new $$WPContain.Popup({Components:[d],TitleText:o,positioningFunction:$$WPContain.Positions.InsideNearTop,Class:"previewCCD",Size:$$WPContain.Popup.SizeEnum.LARGE});f.FocusOnClose=$afe.select("#vdtpreviewbutton");d.show();f.show();$$WPUtil.ShowAjaxSpinner(f.$content.find(".ajaxspinner"));f.$content.find(".iframe").on("load",function(a){d.iframeLoad(a)});k=$afe.select(".visitlist .overallHealthSummary .listelement a")[0];if(k){k.classList.add("selected");k.focus()}return i},clickDownload:function WP$DocumentsDownloadMyRecordController$clickDownload(u){var s="disabled",m="#documentpassword",r="#vdtsidetab",q="@MYCHART@ENDDATE@",p="@MYCHART@STARTDATE@",j="images/lucyrecord_zip_protected.svg",i="images/lucyrecord_zip.svg",l="DownloadTabTextVisits",o="@MYCHART@VISITDATE@",d="documents.downloadmyrecord",h=false,n="@MYCHART@NOTIFICATIONPAGE@",e=true,b,g,k,f,a,c,t;b=u.data||this;g={};f;g.SupressTitle=e;g.TitleText="";g.Class="downloaddocs";c=new $$WP.Documents.DownloadMyRecord.DownloadPopupComponent(g);a={};a.mode=b._activeView;a.PasswordEnabled=b.isVDTDownloadPasswordEnabled;a.PasswordForced=b.isVDTDownloadPasswordForced;a.documentpasswordValidation=new $$WP.FormValidation.ValidationSettings({required:e,minLength:8,maxLength:128,mustMatchField:"passwordverify"});a.passwordverifyValidation=new $$WP.FormValidation.ValidationSettings({mustMatchField:"documentpassword",required:e,maxLength:128});$$WP.Strings.addMnemonic(n,makeLink("Preferences"),h,d);switch(b._activeView){case"singleVisitView":a.csn=b.getCsn();$$WP.Strings.addMnemonic(o,b.getSelectedVisit().DateString,h,d);a.PreText=$$WP.Strings.getForTemplate("DownloadPreTextSingle",d);a.TabText=$$WP.Strings.get(l,d);f=$$WP.Strings.get("DownloadTitleSingle",d);$$WP.Strings.removeMnemonic(o);a.OpenHealthRecordImage=makeStaticLink(i);a.ProtectedHealthRecordImage=makeStaticLink(j);c.downloadCount=2;a.EncCount=1;a.EncDate=b.getSelectedVisit().DateString;break;case"dateRangeView":a.startDate=b._startDate;a.endDate=b._endDate;$$WP.Strings.addMnemonic(p,a.startDate);$$WP.Strings.addMnemonic(q,a.endDate);a.PreText=$$WP.Strings.getForTemplate("DownloadPreTextDateRange",d);a.TabText=$$WP.Strings.getForTemplate(l,d);f=$$WP.Strings.get("DownloadTitleDateRange",d);$$WP.Strings.removeMnemonic(p);$$WP.Strings.removeMnemonic(q);a.OpenHealthRecordImage=makeStaticLink(i);a.ProtectedHealthRecordImage=makeStaticLink(j);c.downloadCount=b._dateRangeCount+2;a.EncCount=b._dateRangeCount;break;case"allVisitsView":a.PreText=a.PreText=$$WP.Strings.getForTemplate("DownloadPreTextAll",d);a.TabText=$$WP.Strings.get(l,d);f=$$WP.Strings.get("DownloadTitleAll",d);a.OpenHealthRecordImage=makeStaticLink(i);a.ProtectedHealthRecordImage=makeStaticLink(j);c.downloadCount=b._allVisitsCount+2;a.EncCount=b._allVisitsCount;break;case"lucySummaryView":a.PreText=$$WP.Strings.getForTemplate("DownloadPreTextLucy",d);a.TabText=$$WP.Strings.get("DownloadTabTextLucy",d);f=$$WP.Strings.get("DownloadTitleHeader",d);a.OpenHealthRecordImage=makeStaticLink(i);a.ProtectedHealthRecordImage=makeStaticLink(j);c.downloadCount=1;a.EncCount=0}$$WP.Strings.removeMnemonic(n);a.DownloadButtonLink=makeLink("Documents/DownloadMyRecord/GetDownloadStarted");c.setData(a);c.addEventListener("click",c.downloadPopupClick);c.addEventListener("keypress",c.downloadPopupClick);c.VDTDownloadPasswordForced=b.isVDTDownloadPasswordForced;t=b.isVDTDownloadPasswordEnabled&&!b.isVDTDownloadPasswordForced?$$WPContain.Positions.InsideNearTop:$$WPContain.Positions.InsideCentered;k=new $$WPContain.Popup({Components:[c],TitleText:f,positioningFunction:t,Class:"singlevisit ",Size:$$WPContain.Popup.SizeEnum.MEDIUM,MonitorAriaLiveContent:h});k.FocusOnClose=$afe.select("#vdtdownloadbutton");c.show();k.show();$afe.select(".Popup input[type='password']").on("blur",$.proxy(c.downloadPopupBlur,c));if(!a.PasswordEnabled||a.PasswordForced){$afe.select(r).removeClass("sidetab");$afe.select(r).addClass("nosidetab");c.$container.trigger("resize",{forceShrink:e})}$afe.select(m).prop(s,e);if(a.PasswordForced){$afe.select(m).prop(s,h);$afe.select(m).val("");$afe.select("#usePwd").removeClass("hidden");$$WP.FormValidation.checkIfFormIsValid($afe.select("#downloadContent form").first(),e)}return h},clickSend:function WP$Documents$DownloadMyRecordController$clickSend(b){var a=b.data;$.ajax({url:makeLink("Documents/DownloadMyRecord/GetListOfStatesAndSpecialties"),type:"POST",dataType:"json",success:function(b){if(a.ContainsException(b)){a.ShowErrorPopup(b);return false}a.initSendPopup(b)}});return false},initSendPopup:function WP$Documents$DownloadMyRecordController$initSendPopup(l){var k="tab_topic_emailAddress",j="h2.sendPopupHeader",g=false,f="documents.downloadmyrecord",c=true,d=this,a,e,h,b,m,i;a={};a.SpecialtyList=l.listOfSpecialties;a.StateList=l.listOfStates;a.Csn=d.getCsn();a.StartDate=d._startDate;a.EndDate=d._endDate;a.ActiveView=d._activeView;a.emailEnabled=d.isSendViaEmailEnabled;a.directEnabled=d.isSendViaDirectEnabled;a.findProviderEnabled=d.isFindProviderEnabled;a.showAddressLink=a.emailEnabled||a.directEnabled;a.Validation=new $$WP.FormValidation.ValidationSettings({required:c});if(a.showAddressLink)if(!a.emailEnabled)a.AddressLinkString=$$WP.Strings.getForTemplate("HaveDirectAddressText",f);else if(!a.directEnabled)a.AddressLinkString=$$WP.Strings.getForTemplate("HaveEmailAddressText",f);else a.AddressLinkString=$$WP.Strings.getForTemplate("HaveAddressText",f);e={};e.SupressTitle=c;e.TitleText="";if(a.findProviderEnabled)e.template=$$WP.Templates.Documents.SearchProviderSend;else if(a.emailEnabled||a.directEnabled){e.template=$$WP.Templates.Documents.AddressEntrySend;a.emailAddressValidation=new $$WP.FormValidation.ValidationSettings({required:c,isEmail:c,mustMatchField:"confirmEmailAddressInput"});a.confirmEmailAddressValidation=new $$WP.FormValidation.ValidationSettings({required:c,isEmail:c,mustMatchField:"emailAddressInput"});a.directAddressValidation=new $$WP.FormValidation.ValidationSettings({required:c,isEmail:c,mustMatchField:"confirmDirectAddressInput"});a.confirmDirectAddressValidation=new $$WP.FormValidation.ValidationSettings({required:c,isEmail:c,mustMatchField:"directAddressInput"});a.showTabs=a.emailEnabled&&a.directEnabled}else return g;b=new $$WP.Documents.DownloadMyRecord.SendPopupComponent(e);b.setData(a);b.backToProviderList=g;b.ContainsException=d.ContainsException;b.ShowErrorPopup=d.ShowErrorPopup;b.addEventListener("click",b.sendOnclick);b.addEventListener("keyup",b.sendOnclick);h=new $$WPContain.Popup({Components:[b],TitleText:$$WP.Strings.get("SendPopupHeader",f),positioningFunction:$$WPContain.Positions.CenterInside,Size:$$WPContain.Popup.SizeEnum.MEDIUM,HasBackButton:g,MonitorAriaLiveContent:g});h.FocusOnClose=$afe.select("#vdtsendbutton");b.show();h.show();if(a.findProviderEnabled){$afe.select(j).first().focus();i=$afe.select(".lastNameInput");i.focus();i.keyup(b.sendOnchange);$afe.select(".firstNameInput").keyup(b.sendOnchange);$afe.select(".specialtyInput").change(b.sendOnchange);$afe.select(".stateInput").change(b.sendOnchange);$$WP.FormValidation.initializeDOMSubtree($afe.select("#sendProviderSendForm"))}else if(a.emailEnabled||a.directEnabled){if(a.showTabs){setupTabbedSections();showTabbedSection(k);$$WP.Utilities.UI.NavTabs({});$afe.select("#tab_topic_emailAddress").focus();$afe.select("a[name=sendpopuptab]").click(b,b.updateTab)}else $afe.select(j).first().focus();b._activeTab=b.Data.emailEnabled?k:"tab_topic_directAddress";$$WP.FormValidation.initializeDOMSubtree($afe.select("#sendPopupTabContent"));$afe.select(".forConfirmation").on("paste",function disablePaste(a){a.preventDefault()})}},ContainsException:function WP$Documents$DownloadMyRecordController$ContainsException(a){if(a.Text&&a.Text==="ErrorCode"){a.NoDataText=$$WP.Strings.get(a.Value,"documents.downloadmyrecord");return true}return false},ShowErrorPopup:function WP$Documents$DownloadMyRecordController$ShowErrorPopup(c){var a="documents.downloadmyrecord",b=new $$WPComp.MessageComponent({TitleText:"Alert",Message:$$WP.Strings.get(c.Value,a),ToolbarButtons:[new $$WPComp.ComplexObjects.Button($$WP.Strings.get("OkayButtonText",a),null,"cancelworkflow","")]});$$WPUtil.quickPopup(b)},dateRangeValidatorAndErrorHandler:function WP$Documents$DownloadMyRecordController$dateRangeValidatorAndErrorHandler(q,r){var p="#dateRangeList",e="hidden",o="#daterangeformaterror",k="documents.downloadmyrecord",n="DateFormatErrorText",j="daterangeformaterror",c="disabled",i=".formbuttons input",a=true,b=false,d=this,m,t,s,h,l,f,g;m=b;t=new Date(q);s=new Date(r);h=formatDateField(d._startDateEntryElement,4,"","",a);l=formatDateField(d._endDateEntryElement,4,"","",a);f=b;g=b;changeErrorField("maxlimiterror","");changeErrorField("maxtransmitlimiterror","");if(q==="")f=a;if(r==="")g=a;if(!f&&h===b||!g&&l===b){$afe.select(i).safeAttr(c,c);d._dateRangeInvalid=a;changeErrorField(j,$$WP.Strings.get(n,k))}else if(!f&&h===undefined||!g&&l===undefined){$afe.select(i).safeAttr(c,c);d._dateRangeInvalid=a;changeErrorField(j,$$WP.Strings.get(n,k))}else if(s<t){$afe.select(i).safeAttr(c,c);d._dateRangeInvalid=a;changeErrorField(j,$$WP.Strings.get("DateOrderErrorText",k))}else{d._dateRangeInvalid=b;m=a}if(m){$afe.select(o).addClass(e);$afe.select(p).removeClass(e);return a}else{$afe.select("#dateRangeText").addClass(e);$afe.select(p).addClass(e);$afe.select(o).removeClass(e);return b}},initializePagination:function WP$Documents$DownloadMyRecordController$initializePagination(a,b){$$WP.Strings.setDefaultNamespace("documents.downloadmyrecord");a._pagingCurrentPage=0;$afe.select("table.paginated").each(function(){var f="tbody tr",h="repaginate";a._pagingNumPerPage=10;var d=$afe.jq(this);d.on(h,function(){d.find(f).addClass("hidden").slice(a._pagingCurrentPage*a._pagingNumPerPage,(a._pagingCurrentPage+1)*a._pagingNumPerPage).removeClass("hidden")});d.trigger(h);var j=d.find(f).length;if(j<1){$afe.select("#NextTableRowId").val(-1);return null}var i=Math.ceil(j/a._pagingNumPerPage);if(i===1)return false;a._pagingNumPages=i;var c=document.createElement("nav");c.id="visitPager";c.className="pager";c=$afe.jq(c);c.attr("role","navigation");c.attr("aria-label",$$WP.Strings.get("PaginationTitle"));a.renderPrevNavLinks(a,c);a.renderPageNavLinks(a,d,c);a.renderNextNavLinks(a,c);c.safeInsertAfter(d).find("a#page-number-0").addClass("active");if(b!==undefined&&!isNaN(b,10)){var k="a#page-number-"+b;$afe.select(k).trigger("click").focus()}var e=document.createElement("div"),g=document.createElement("div");e.id="pagerAriaContainer";g.className="clearlabel";g.id="ariaPageChangeContent";e=$afe.jq(e);g=$afe.jq(g);g.safeAppendTo(e);e.attr("aria-live","polite");e.safeInsertAfter(d)});this.addPaginationListeners();$$WP.Strings.clearDefaultNamespace()},renderPrevNavLinks:function WP$Documents$DownloadMyRecordController$renderPrevNavLinks(a,e){var c="tabindex",d=$('<a href="#" class="pagerBtn first disabled" title="'+$$WP.Strings.get("FirstPageAnchorTitle")+'"></a>'),b=$('<a href="#" class="pagerBtn prev disabled" title="'+$$WP.Strings.get("PreviousPageAnchorTitle")+'"></a>');d.on("click",function(b){if($afe.jq(this).hasClass("disabled")){b.preventDefault();b.stopImmediatePropagation();return}a.goToFirstPage()}).safeAppendTo(e);if(a._pagingCurrentPage===0){d.attr(c,-1);b.attr(c,-1)}b.on("click",function(b){if(a._pagingCurrentPage>0)a.goToPreviousPage();else{b.preventDefault();b.stopImmediatePropagation()}}).safeAppendTo(e)},renderPageNavLinks:function WP$Documents$DownloadMyRecordController$renderPageLinks(a,h,g){var c="aria-current",d="@MYCHART@PAGENUMBER@";for(var b=0;b<a._pagingNumPages;b++){$$WP.Strings.addMnemonic(d,b+1);var f=$$WP.Strings.get("PageNumberAnchorTitle"),e=$('<a href="#" id="page-number-'+b+'" class="pageNum" data-page-num="'+b+'"></a>');b===a._pagingCurrentPage&&e.attr(c,"page");e.attr("aria-label",f).text(b+1).on("click",{newPage:b},function(e){var b="active",d=this;a._pagingCurrentPage=e.data.newPage;if($afe.jq(d).hasClass(b)){e.preventDefault();e.stopImmediatePropagation();return}a.setPagerNavAriaLabel();h.trigger("repaginate");$afe.jq(d).addClass(b).siblings().removeClass(b);$afe.jq(d).attr(c,"page");$afe.jq(d).siblings().removeAttr(c);switch(a._pagingCurrentPage){case 0:a.disableFirstPage();break;case a._pagingNumPages-1:a.disableLastPage();break;default:a.enableEndButtons()}}).safeAppendTo(g).addClass("pagerSpan");$$WP.Strings.removeMnemonic(d)}},setPagerNavAriaLabel:function WP$Documents$DownloadMyRecordController$setPagerNavAriaLabel(){var c="#page-number-"+this._pagingCurrentPage,b=$afe.select(c),a=$afe.select("#ariaPageChangeContent");a.text(b.attr("aria-label"))},renderNextNavLinks:function WP$Documents$DownloadMyRecordController$renderNextNavLinks(a,b){var d=$('<a href="#" class="pagerBtn next" title="'+$$WP.Strings.get("NextPageAnchorTitle")+'"></a>');d.on("click",function(b){a._pagingCurrentPage<a._pagingNumPages-1&&a.goToNextPage();if(a._pagingCurrentPage===a._pagingNumPages-1){b.preventDefault();b.stopImmediatePropagation()}}).safeAppendTo(b);var c=$('<a href="#" class="pagerBtn last load-all" title="'+$$WP.Strings.get("LastPageAnchorTitle")+'"></a>');c.on("click",function(b){if(a._pagingCurrentPage==a._pagingNumPages-1){b.preventDefault();b.stopImmediatePropagation()}else a.goToLastPage()}).safeAppendTo(b)},goToFirstPage:function WP$Documents$DownloadMyRecordController$goToFirstPage(){this._pagingCurrentPage=0;this.changeToActivePage()},goToPreviousPage:function WP$Documents$DownloadMyRecordController$goToPreviousPage(){this._pagingCurrentPage=this._pagingCurrentPage-1;this.changeToActivePage()},goToNextPage:function WP$Documents$DownloadMyRecordController$goToNextPage(){this._pagingCurrentPage=this._pagingCurrentPage+1;this.changeToActivePage()},goToLastPage:function WP$Documents$DownloadMyRecordController$goToLastPage(){var a=this;if(a._canLoadMorePages===false||a._singleVisitsEndDAT===""){a._pagingCurrentPage=a._pagingNumPages-1;a.changeToActivePage();return false}},changeToActivePage:function WP$Documents$DownloadMyRecordController$changeToActivePage(){var a=this;a.changeActiveNavNumber();$afe.jq($afe.select("table.paginated")).trigger("repaginate");switch(a._pagingCurrentPage){case 0:a.disableFirstPage();break;case a._pagingNumPages-1:a.disableLastPage();break;default:a.enableEndButtons()}},changeActiveNavNumber:function WP$Documents$DownloadMyRecordController$updateFirstPageAsDisabled(){var a="aria-current",c="#page-number-"+this._pagingCurrentPage,b=$afe.select(c);b.siblings().removeClass("active").siblings().removeAttr(a);b.addClass("active").safeAttr(a,"page")},disableFirstPage:function WP$Documents$DownloadMyRecordController$updateFirstPageAsDisabled(){var f=".pagerBtn.last",e=".pagerBtn.next",d=".pagerBtn.prev",b="tabindex",a="disabled",c=".pagerBtn.first";$afe.select(c).addClass(a);$afe.select(c).attr(b,-1);$afe.select(d).addClass(a);$afe.select(d).attr(b,-1);$afe.select(e).removeClass(a);$afe.select(e).removeAttr(b);$afe.select(f).removeClass(a);$afe.select(f).removeAttr(b)},disableLastPage:function WP$Documents$DownloadMyRecordController$updateLastPageAsDisabled(){var f=".pagerBtn.prev",e=".pagerBtn.first",d=".pagerBtn.next",b="tabindex",a="disabled",c=".pagerBtn.last";$afe.select(c).addClass(a);$afe.select(c).attr(b,-1);$afe.select(d).addClass(a);$afe.select(d).attr(b,-1);$afe.select(e).removeClass(a);$afe.select(e).removeAttr(b);$afe.select(f).removeClass(a);$afe.select(f).removeAttr(b)},enableEndButtons:function WP$Documents$DownloadMyRecordController$updateLastPageAsDisabled(){var f=".pagerBtn.last",e=".pagerBtn.next",d=".pagerBtn.prev",b="tabindex",a="disabled",c=".pagerBtn.first";$afe.select(c).removeClass(a);$afe.select(c).removeAttr(b);$afe.select(d).removeClass(a);$afe.select(d).removeAttr(b);$afe.select(e).removeClass(a);$afe.select(e).removeAttr(b);$afe.select(f).removeClass(a);$afe.select(f).removeAttr(b)},addPaginationListeners:function WP$Documents$DownloadMyRecordController$addPaginationListeners(){var c=".pagerBtn",b=".pageNum",a=this;$afe.select(b).click(a,a.addVisits);$afe.select(b).click(a,a.updateVisiblePages);$afe.select(b).click(a,a.setVisitDefault);$afe.select(b).click(a,function(){$$WPUtil.setScrollTop($afe.select("#main").offset().top)});$afe.select(c).click(a,a.addVisits);$afe.select(c).click(a,a.updateVisiblePages);$afe.select(c).not(".last").click(a,a.setVisitDefault);$afe.select(c).click(a,function(){$$WPUtil.setScrollTop($afe.select("#main").offset().top)});$afe.select(".pagerBtn.last").click(a,a.addAllVisits)},addAllVisits:function WP$Documents$DownloadMyRecordController$addAllVisits(b){var a=b.data||this;if(a._singleVisitsEndDAT===""||a._pagingInitialPages>a._pagingNumPages||a._canLoadMorePages===false){a._canLoadMorePages=false;a.setVisitDefault(a);return false}a.getSingleVisits(a,a._loadAllVisitsCount)},addVisits:function WP$Documents$DownloadMyRecordController$addVisits(c){var a,b;a=c.data||this;if(a._singleVisitsEndDAT===""||a._pagingInitialPages>a._pagingNumPages||a._canLoadMorePages===false)return false;if(a._pagingCurrentPage>a._pagingNumPages-3){a._canLoadMorePages=false;b=a.getSingleVisits(a,a._visitsPerAddition)}},updateVisiblePages:function WP$Documents$DownloadMyRecordController$updateVisiblePages(f){var c,e,b,a,d;c=f.data||this;e=c._pagingCurrentPage;b,a;d=c._pagingNumPages;if(c._pagingNumPages<=5)return false;b=e-2;a=e+2;if(b<0){a-=b;b=0}else if(a>d-1){b-=a-d+1;a=d-1}$afe.select("a.pageNum").each(function(c){if(c<b||c>a)$afe.jq(this).addClass("hidden");else $afe.jq(this).removeClass("hidden")})},updatePaging:function WP$Documents$DownloadMyRecordController$updatePaging(d,e){var a=this,c,b,f;b=a;f="";if(!d)d.this._singleVisits;a.createVisitRecordRows(d);if(e)c=b._pagingNumPages+Math.ceil(b._singleVisits.length/5)-1;else c=parseInt($afe.select("#visitPager a.active")[0].innerHTML,10)-1;$afe.select("#visitPager").remove();$afe.select("#pagerAriaContainer").remove();a.initializePagination(a,c);e&&b.goToLastPage();a.updateVisiblePages(a);a._canLoadMorePages=true},createVisitRecordRows:function WP$Documents$DownloadMyRecordController$createVisitRecordRows(d){var a=this,b,c;b={};b.VisitList=d;b.NextRowId=a._nextRowId;a.formatVisitDescription(b.VisitList);c=$afe.renderTemplate($$WP.Templates.Documents.VisitRecordRow,b);$afe.select("#visitRecords").safeAppend(c);$afe.select("tr.singlevisitrow").click(a,a.visitRowClick);a._nextRowId=a._nextRowId+d.length},setupProvidersForPopup:function WP$Documents$DownloadMyRecordController$setupProviderForPopup(c){for(var a,b=0;b<c.length;b++){a=c[b];if(a.Providers!==null&&a.Providers.length>0)a.Provider=a.Providers[0].Name||""}},formatVisitDescription:function WP$Documents$DownloadMyRecordController$formatVisitDescription(g){var b="documents.downloadmyrecord",f="@MYCHART@PROVIDER@",e="@MYCHART@VISITTYPE@";for(var a,c,d=0;d<g.length;d++){a=g[d];c=false;if(a.Providers!==null&&a.Providers.length>0)if(!$$WPUtil.IsNullOrEmpty(a.Providers[0].Name))c=true;switch(a.Type){case 3:case 5:case 6:$$WP.Strings.addMnemonic(e,a.VisitType.Name);if(c){$$WP.Strings.addMnemonic(f,a.Providers[0].Name);a.DescriptionToShow=$$WP.Strings.getForTemplate("VisitDescriptionWithProvider",b);$$WP.Strings.removeMnemonic(f)}else a.DescriptionToShow=$$WP.Strings.getForTemplate("VisitDescription",b);$$WP.Strings.removeMnemonic(e);break;case 4:a.DescriptionToShow=$$WP.Strings.getForTemplate("HospitalVisitDescription",b);break;default:a.DescriptionToShow=$$WP.Strings.getForTemplate("NoVisitDescription",b)}}}};$$WP.Documents.DownloadMyRecordController.extend("Controllers.Controller")