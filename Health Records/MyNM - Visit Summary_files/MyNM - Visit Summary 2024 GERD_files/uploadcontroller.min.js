!function ClassDefinition(){$$WP.Utilities.guaranteeExistence($$WP,"Upload.Controllers");var e="WP_FILE_UPLOAD",t=function UploadController(e,t,i,n,o){var s;if(this.WP$Controllers$Controller(),this._viewContainer$=e,this._documentCollection=new $$WP.Common.ModelCollection([{propertyNames:"DocumentId",storeAs:"single"}],[],[]),this._isConfigLoaded=!1,this._settings=t,this._documentModelClass=n||$$WP.Upload.Models.Document,this.__afterRefreshView=o,i&&i.length>0)for(s=0;s<i.length;++s)this._documentCollection.add(new this._documentModelClass(i[s]));this.__pendingUploadFiles=[],this.proxify("_onAddButtonClicked","_onRemoveButtonClicked","_uploadFile","_onFileNameEdited","__onDropFiles","__onDragEnter","__onDragLeave","_onFileNameInputKeyPressed","_onViewButtonClicked"),this._getConfig(),this._refreshView(),this._attachEventHandlers()};t.prototype={_viewContainer$:null,_settings:null,_documentCollection:null,_documentModelClass:null,__afterRefreshView:null,_isConfigLoaded:null,_getConfig:function _getConfig(){if(this._settings.ConfigUrl){this._isConfigLoaded=!1,this.__isFunction(this._settings.onConfigStart)&&this._settings.onConfigStart();var e=this._settings.UseGet?"GET":"POST";$.ajax({type:e,dataType:"json",data:$$WPUtil.postify(this._settings.ContextData),url:this._settings.ConfigUrl}).done($.proxy(this.__onConfigSuccess,this)).fail($.proxy(this.__onConfigFail,this))}else this._isConfigLoaded=!0},__onConfigSuccess:function __onConfigSuccess(e){if(e.Success){this._isConfigLoaded=!0;var t=new $$WP.Upload.Models.UploadConfiguration(e.Data);this._settings.AllowedExtensions=t.AllowedExtensions,this._settings.AllowedImageAndDocumentExtensions=t.AllowedImageAndDocumentExtensions,this._settings.AllowedVideoExtensions=t.AllowedVideoExtensions,this._settings.MaxAllowedImageSize=t.MaxAllowedImageSize,this._settings.MaxAllowedVideoSize=t.MaxAllowedVideoSize,this._settings.MaxFilesAllowed=t.MaxFilesAllowed,this._settings.IsPhotoForPatientsChart=t.IsPhotoForPatientsChart,this._refreshView(),this.__isFunction(this._settings.onConfigSucess)&&this._settings.onConfigSucess(this._settings,e.Data)}else this.__onConfigFail(e)},__onConfigFail:function __onConfigFail(e){this._handleCommunicationFail(n.GetConfig,e)},__pendingUploadFiles:null,_uploadFile:function _uploadFile(e){var t=this._viewContainer$.find(".upload-input[data-function='upload-core']").prop("files");this.__uploadFileCore(t)},__uploadFileCore:function __uploadFileCore(e){var t,n;if(this._settings.MaxFilesAllowed<this._documentCollection.Models.length+e.length)return this.__isFunction(this._settings.onUploadFail)&&this._settings.onUploadFail(),void this._showErrorMessage("FileNotAcceptedPopupTooManyFilesErrorText","FileNotAcceptedPopupHeaderText","FileNotAcceptedPopupButtonText");for(t=0;t<e.length;++t)if(0!==(n=this._settings.IsFileAceptable(e[t].name,e[t].size))){switch(this.__isFunction(this._settings.onUploadFail)&&this._settings.onUploadFail(),n){case 1:this._showErrorMessage("FileNotAcceptedPopupWrongExtensionErrorText","FileNotAcceptedPopupHeaderText","FileNotAcceptedPopupButtonText");break;case 2:this._settings.MaxAllowedImageSize>=1024?this._showErrorMessage("FileNotAcceptedPopupLargeImageErrorText","FileNotAcceptedPopupHeaderText","FileNotAcceptedPopupButtonText"):this._showErrorMessage("FileNotAcceptedPopupLargeImageErrorTextKb","FileNotAcceptedPopupHeaderText","FileNotAcceptedPopupButtonText");break;case 3:this._showErrorMessage("FileNotAcceptedPopupLargeVideoErrorText","FileNotAcceptedPopupHeaderText","FileNotAcceptedPopupButtonText");break;case 4:this._showErrorMessage("FileNotAcceptedPopupInvalidFilenameErrorText","FileNotAcceptedPopupHeaderText","FileNotAcceptedPopupButtonText")}return}if(i)this._showErrorMessage("FileNotAcceptedPopupAnotherUploadErrorText","FileNotAcceptedPopupHeaderText","FileNotAcceptedPopupButtonText");else{for(t=0;t<e.length;++t)"function"==typeof this._settings.ConfirmFunction?this._settings.ConfirmFunction.call(this._settings.MasterController,e[t],this._settings.ConfirmationViewModel,this.__pushToPending,this):this.__pendingUploadFiles.push(e[t]);this._settings.ConfirmFunction||this.__flushUploadQueue()}},__pushToPending:function(e){this.__pendingUploadFiles.push(e),this.__flushUploadQueue()},__flushUploadQueue:function __flushUploadQueue(){var t,n;if(0===(this.__pendingUploadFiles||[]).length)return i=!1,this._refreshView(!0),void($$WP.Performance&&$$WP.Performance.Tracker&&$$WP.Performance.Tracker.endMeasurement(e));if($$WP.Performance&&$$WP.Performance.Tracker&&$$WP.Performance.Tracker.startMeasurement(e),this.__isFunction(this._settings.onUploadStart)&&this._settings.onUploadStart(),i=!0,this._refreshView(!0),t=this.__pendingUploadFiles.shift(),(n=new FormData).append("__file__[]",t),this._serializeContextToFormData(n,this._settings.ContextData),this._settings.FromVBPage){var o=this;getCSRFTokenAsQS((function(){$.ajax({type:"POST",processData:!1,contentType:!1,data:n,url:o._settings.UploadUrl,suppressEpicDefaultAjaxErrorHandler:!0}).done($.proxy(o.__onUploadSuccess,o)).fail($.proxy(o.__onUploadFail,o))}))}else $.ajax({type:"POST",processData:!1,contentType:!1,data:n,url:this._settings.UploadUrl,suppressEpicDefaultAjaxErrorHandler:!0}).done($.proxy(this.__onUploadSuccess,this)).fail($.proxy(this.__onUploadFail,this))},__onUploadSuccess:function __onUploadSuccess(t){var i,n,o;if(t.Success){for(o=[],n=(t.Data||[]).length,i=0;i<n;++i)o.push(new this._documentModelClass(t.Data[i]));this._documentCollection.addRange(o),this._refreshView(),this.__isFunction(this._settings.onUploadSuccess)&&this._settings.onUploadSuccess(o,t),this._viewContainer$.find("[name^='name-field']").last().focus(),this.__flushUploadQueue()}else this.__onUploadFail(t),$$WP.Performance&&$$WP.Performance.Tracker&&$$WP.Performance.Tracker.endMeasurement(e)},__onUploadFail:function __onUploadFail(t){i=!1,this.__isFunction(this._settings.onUploadFail)&&this._settings.onUploadFail(),this.__pendingUploadFiles=[],this._refreshView(!0),this._handleCommunicationFail(n.UploadFile,t),$$WP.Performance&&$$WP.Performance.Tracker&&$$WP.Performance.Tracker.endMeasurement(e)},_editFileName:function _editFileName(e){var t=e.toRawObject()||{};t.ContextData=this._settings.ContextData,this.__isFunction(this._settings.onEditStart)&&this._settings.onEditStart(),$.ajax({type:"POST",url:this._settings.EditUrl,data:$$WPUtil.postify(t),dataType:"json"}).done($.proxy(this._editFileNameSuccess,this)).fail($.proxy(this.__editFileNameFail,this))},_editFileNameSuccess:function _editFileNameSuccess(e){if(e.Success){var t=this._documentCollection.getFirstInIndex("DocumentId",e.Data.DocumentId);this.__isFunction(this._settings.onEditSuccess)&&this._settings.onEditSuccess(t,e)}else this.__editFileNameFail(e)},__editFileNameFail:function __editFileNameFail(e){this._handleCommunicationFail(n.EditFileName,e)},_deleteFile:function _deleteFile(e){var t=e.toRawObject()||{};t.ContextData=this._settings.ContextData,this.__isFunction(this._settings.onDeleteStart)&&this._settings.onDeleteStart(e.DocumentId),$.ajax({dataType:"json",type:"POST",url:this._settings.DeleteUrl,data:$$WPUtil.postify(t)}).done($.proxy(this.__deleteSuccess,this,e)).fail($.proxy(this.__deleteFail,this))},__deleteSuccess:function _deleteFile(e,t){t.Success?e&&(this._documentCollection.remove(e),this._refreshView(),this._viewContainer$.find(".addItem a").focus(),this._viewContainer$.find(".addItem a").parent().addClass("hover"),this.__isFunction(this._settings.onDeleteSuccess)&&this._settings.onDeleteSuccess(e,t)):this.__deleteFail(t)},__deleteFail:function __deleteFail(e){this._handleCommunicationFail(n.DeleteFile,e)},_refreshView:function _refreshView(e){if("function"!=typeof this._settings.RefreshViewOverride){var t={Configuration:this._settings,IsCurrentlyUploading:i,IsLimitReached:this._documentCollection.Models.length>=this._settings.MaxFilesAllowed,IsConfigLoading:!1===this._isConfigLoaded,CanUpload:!i&&this._documentCollection.Models.length<this._settings.MaxFilesAllowed&&this._isConfigLoaded};$$WP.Strings.setDefaultNamespace(this._settings.DefaultStringNamespace),t.Documents=this._documentCollection.Models,e?this._viewContainer$.find(".upload-addFile").safeReplaceWith($afe.renderTemplate(this._settings.UploadCardTemplate,t)):this._viewContainer$.empty().safeAppend($afe.renderTemplate(this._settings.ViewTemplate,t)),$$WP.Strings.clearDefaultNamespace(),this._viewContainer$.find(".cardlist").trigger("cardLoad"),"function"==typeof this.__afterRefreshView&&this.__afterRefreshView()}else this._settings.RefreshViewOverride.call(this,this)},_attachEventHandlers:function _attachEventHandlers(){this.__isFunction(this._settings.AttachContainerEventHandlers)&&this._settings.AttachContainerEventHandlers(),this.__isFunction(this._settings.AttachFileCardEventHandlers)&&this._settings.AttachFileCardEventHandlers(),this._viewContainer$.on("click keypress","[data-function='upload']",this._onAddButtonClicked),this._viewContainer$.on("click","[data-function='remove']",this._onRemoveButtonClicked),this._viewContainer$.on("click","[data-function='view']",this._onViewButtonClicked),this._viewContainer$.on("change","[data-function='upload-core']",this._uploadFile),this._viewContainer$.on("blur","[data-function='edit-label-input']",this._onFileNameEdited),this._viewContainer$.on("keypress","[data-function='edit-label-input']",this._onFileNameInputKeyPressed),this._viewContainer$.on("dragover drop dragenter dragleave dragstart dragend","[data-dragregion]",(function(e){e.stopPropagation(),e.preventDefault()})),this._viewContainer$.on("dragover","[data-dragregion]",(function(e){e.originalEvent.dataTransfer.dropEffect="copy"})),this._viewContainer$.on("drop","[data-dragregion]",this.__onDropFiles),this._viewContainer$.on("dragover dragenter","[data-dragregion]",this.__onDragEnter),this._viewContainer$.on("dragleave dragend","[data-dragregion]",this.__onDragLeave)},__onDropFiles:function __onDropFiles(e){var t=e.originalEvent.dataTransfer.files||[];this.__uploadFileCore(t)},__onDragEnter:function __onDragEnter(){this._viewContainer$.find("[data-function='upload']").addClass("hover")},__onDragLeave:function __onDragLeave(){this._viewContainer$.find("[data-function='upload']").removeClass("hover")},_onFileNameEdited:function _onFileNameEdited(e){var t,i=$afe.jq(e.target).closest("input"),n=(i.val()||"").trim(),o=$$WP.Common.Model.getInstance(i.data("model-id"));n.length>0&&n.length<=100&&o&&n!==o.FileDisplayName?(o.FileDisplayName=n,this._editFileName(o),this._refreshView(),e.relatedTarget&&e.relatedTarget.value&&e.relatedTarget.dataset.modelId&&e.relatedTarget.dataset.modelId&&(t=this._viewContainer$.find(".upload--document-card [data-model-id='"+e.relatedTarget.dataset.modelId+"'][value='"+e.relatedTarget.value+"']").first()[0]),t&&t.value==e.relatedTarget.value?t.focus():null!=e.relatedTarget&&e.relatedTarget.focus()):i.val(o.FileDisplayName)},_onFileNameInputKeyPressed:function _onFileNameInputKeyPressed(e){13===(e.which||e.keyCode)&&(e.stopPropagation(),this._viewContainer$.find("[data-function='edit-label-input']").trigger("blur"))},_onAddButtonClicked:function _onAddButtonClicked(e){"keypress"===e.type&&13!==e.keyCode||(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault(),i?new $$WPUtil.quickMessageBox($$WP.Strings.get("FileNotAcceptedPopupAnotherUploadErrorText","Upload"),$$WP.Strings.get("FileNotAcceptedPopupHeaderText","Upload"),[new $$WPComp.ComplexObjects.Button($$WP.Strings.get("FileNotAcceptedPopupButtonText","Upload"),null,"previousstep","continue")]):this._settings.NeedsRedirect?($$WPUtil.SafeToRedirectOverrideSettings={TitleText:this._settings.RedirectTitle,Html:this._settings.RedirectHtml},$$WPUtil.SafeToRedirect($.proxy(this._continueUpload,this))):this._triggerInputClick())},_triggerInputClick:function _triggerInputClick(){this._viewContainer$.find("input[type='file'][data-function='upload-core']").trigger("click")},_continueUpload:function _continueUpload(e){$$WPUtil.SafeToRedirectOverrideSettings={},e&&this._triggerInputClick()},_onRemoveButtonClicked:function _onRemoveButtonClicked(e){var t=$afe.jq(e.target),i=$$WP.Common.Model.getInstance(t.data("model-id"));$$WP.Strings.setDefaultNamespace(this._settings.DefaultStringNamespace),$$WP.Strings.addMnemonic("@MYCHART@DOCUMENTNAME@",i.FileDisplayName);var n=[new $$WPComp.ComplexObjects.Button($$WP.Strings.get("DocumentRemovePopupRemoveButtonText"),null,"inlinedelete","remove"),new $$WPComp.ComplexObjects.Button($$WP.Strings.get("DocumentRemovePopupGoBackButtonText"),null,"cancel","cancel")];new $$WPUtil.quickMessageBox($$WP.Strings.get("DocumentRemovePopupDescriptionText"),$$WP.Strings.get("DocumentRemovePopupHeaderText"),n,$.proxy(this._onRemovePopupButtonClicked,this),[i]),$$WP.Strings.removeMnemonic("@MYCHART@DOCUMENTNAME@"),$$WP.Strings.clearDefaultNamespace()},_onRemovePopupButtonClicked:function _onRemovePopupButtonClicked(e,t){if(t===$$WPComp.TOOLBARIDENTIFIER+"remove"){var i=$afe.select("#uploadAriaAnnouncements");$$WP.Strings.setDisplayText(i,"DocumentRemoveConfirmationText",this._settings.DefaultStringNamespace),this._viewContainer$.find(".addItem a").focus(),this._deleteFile(e)}},_onViewButtonClicked:function _onViewButtonClicked(e){e.stopPropagation(),e.preventDefault();var t=$afe.jq(e.target),i=$$WP.Common.Model.getInstance(t.data("model-id"));if($$WP.Utilities.UI.IsMobile&&!this._settings.FromBedside){var n=!1;WP.Events.showBeforeUnloadMessage()&&(WP.Events.cancelBeforeUnload(),n=!0);var o="epichttp://attachment?dcsId="+encodeURIComponent(i.DocumentId)+"&dcsExt="+i.FileExtensionWithoutDot;window.location.assign(o),n&&WP.Events.beforeUnload()}else{var s=new $$WP.Documents.ViewDocument.Models.DocumentModel(null,{},encodeURIComponent(i.FileReference),encodeURIComponent(i.DocumentId),i.FileDisplayName,i.FileExtensionWithoutDot,null,null,null,null,null,null,null,null,null,null,encodeURIComponent(this._settings.ViewerCsn));i.AllowPreview||(s.AllowPreview=!1),s.openDocument("uploadWidget sm-autosizedpopup")}},getAllDocuments:function getAllDocuments(){return this._documentCollection.Models},getDocumentCollection:function getDocumentCollection(){return this._documentCollection},getUploadContextData:function getUploadContextData(){var e=null;return $$WPUtil.IsNullOrEmpty(this._settings)||(e=this._settings.ContextData),e},DeleteFile:function DeleteFile(e){this._deleteFile(e)},RefreshView:function RefreshView(e){this._refreshView(e)},_serializeContextToFormData:function _serializeContextToFormData(e,t){var i;if(t)for(i in t)e.append(i,t[i])},_handleCommunicationFail:function _handleCommunicationFail(e,t){var i=!0,o="";switch(e){case n.GetConfig:i=!this.__isFunction(this._settings.onConfigFail)||this._settings.onConfigFail(t),o="ServerErrorPopupDescriptionGetConfigFailedText";break;case n.UploadFile:i=!this.__isFunction(this._settings.onUploadFail)||this._settings.onUploadFail(t),o="ServerErrorPopupDescriptionUploadFileFailedText";break;case n.EditFileName:i=!this.__isFunction(this._settings.onEditFail)||this._settings.onEditFail(t),o="ServerErrorPopupDescriptionEditFileFailedText";break;case n.DeleteFile:i=!this.__isFunction(this._settings.onDeleteFail)||this._settings.onDeleteFail(t),o="ServerErrorPopupDescriptionDeleteFileFailedText"}!1!==i&&this._showErrorMessage(o,"ServerErrorPopupHeaderText","ServerErrorPopupButtonText")},_showErrorMessage:function _showErrorMessage(e,t,i){$$WP.Strings.setDefaultNamespace(this._settings.DefaultStringNamespace),$$WP.Strings.addMnemonic("@MYCHART@MAXUPLOADS@",this._settings.MaxFilesAllowed),$$WP.Strings.addMnemonic("@MYCHART@ALLOWEDEXTENSIONS@",this._settings.AllowedExtensions.join(", ")),$$WP.Strings.addMnemonic("@MYCHART@ALLOWEDIMAGESIZE@",Math.floor(10*this._settings.MaxAllowedImageSize/1024)/10),$$WP.Strings.addMnemonic("@MYCHART@ALLOWEDIMAGESIZEKB@",this._settings.MaxAllowedImageSize),$$WP.Strings.addMnemonic("@MYCHART@ALLOWEDVIDEOSIZE@",Math.floor(10*this._settings.MaxAllowedVideoSize/1024)/10),"FileNotAcceptedPopupWrongExtensionErrorText"==e&&0==this._settings.AllowedExtensions.length&&(e="FileNotAcceptedPopupWrongExtensionErrorTextNoExtensions"),new $$WPUtil.quickMessageBox($$WP.Strings.get(e),$$WP.Strings.get(t),[new $$WPComp.ComplexObjects.Button($$WP.Strings.get(i),null,"previousstep","continue")],function(e,t){var i=this._viewContainer$.find(".upload-addFile a");i[0]&&i[0].focus()}.bind(this),[]),$$WP.Strings.removeMnemonic("@MYCHART@ALLOWEDVIDEOSIZE@"),$$WP.Strings.removeMnemonic("@MYCHART@ALLOWEDIMAGESIZE@"),$$WP.Strings.removeMnemonic("@MYCHART@ALLOWEDIMAGESIZEKB@"),$$WP.Strings.removeMnemonic("@MYCHART@ALLOWEDEXTENSIONS@"),$$WP.Strings.removeMnemonic("@MYCHART@MAXUPLOADS@"),$$WP.Strings.clearDefaultNamespace(),this._refreshView()},__isFunction:function __isFunction(e){return e&&"function"==typeof e}};var i=!1,n={GetConfig:1,UploadFile:2,EditFileName:3,DeleteFile:4};$$WP.Upload.Controllers.UploadController=t,$$WP.Upload.Controllers.IsCurrentlyUploading=function IsCurrentlyUploading(){return i},t.extend($$WP.Controllers.Controller,"$$WP$Upload$Controllers$UploadController")}();