!function ClassDefinition(){$$WP.Utilities.guaranteeExistence($$WP,"ProxySwitch.Controllers");var e=function WP$ProxySwitch$Controllers$ProxySelectorController(e){this.$switchRoot=e,this.strings=$$WP.Strings.getNamespace("ProxySwitch.ProxySwitch.ProxySelector"),this.lastCloseTime=0,this.photoTemplate=$$WP.Templates.ProxySwitch.PatientRoundIcon,this.switchTemplate=$$WP.Templates.ProxySwitch.DropDownProxySelector,this.subjectListTemplate=$$WP.Templates.ProxySwitch.SubjectList,$.ajax({url:makeLink("ProxySwitch"),success:this._onModelLoaded.bind(this),type:"GET",dataType:"JSON"}),this.keyCode={TAB:9,RETURN:13,ESC:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40},this.proxify("_showPhotoConfirmationCore")};e.prototype={$switchRoot:null,switchTemplate:null,modelData:null,photoTemplate:null,popupMenuController:!1,dontReopen:!1,$popupMenu:null,$menuButton:null,strings:null,lastCloseTime:0,uploadController:null,subjectListTemplate:null,_onModelLoaded:function WP$ProxySwitch$Controllers$ProxySelectorController$_onModelLoaded(e){this.modelData=new $$WP.ProxySwitch.Models.ProxySelectorViewModel(e),this._render(),this.modelData.Loading&&setTimeout(this.retry.bind(this),5e3)},_render:function WP$ProxySwitch$Controllers$ProxySelectorController$_render(){this._registerPartialTemplates(),this.$switchRoot.safeAppend($afe.renderTemplate(this.switchTemplate,this.modelData,{})),this.$menuButton=this.$switchRoot.find(".proxyMenuButton"),this.$menuButton.safeAttr("aria-haspopup","true"),this.$popupMenu=$("#proxyList"),$afe.jq(window).on("resize",$.proxy(this._onResize,this)),1===this.$popupMenu.length&&(this.popupMenuController=new $$WP.ProxySwitch.Controllers.ProxyPopupMenuController(this.$popupMenu,this)),this._onResize(),!0===this.modelData.ShowPhotoUpload&&this._createUploadController();var e=document.querySelector(".logOutListItem");e&&e.addEventListener("click",$$WP.Utilities.UI._logOutHandler),this.$menuButton.on("click",this._handleClick.bind(this)),$afe.select(".proxyMenuShield").on("click",this._handleClick.bind(this)),this.$menuButton.on("keydown",this._handleKeydown.bind(this)),WP.DOM.Browser.isIE&&$afe.select(".proxySelectorDropDownNameEllipsis").safeAttr("aria-hidden","false"),$afe.select(".roundedPatientPhoto").children("img").on("error",this._onPhotoIconError.bind(this))},_onResize:function WP$ProxySwitch$Controllers$ProxySelectorController$_onResize(){var e=this.$switchRoot.find(".proxySwitchNav");if(!(!this.$menuButton||this.$menuButton.length<1||!e||e.length<1)){var t=this.$menuButton[0].getBoundingClientRect().height;if("fixed"!==e.css("position"))e.css("top",t);else{var o=this.$menuButton[0].getBoundingClientRect().top;e.css("top",o+t)}}},retry:function WP$ProxySwitch$Controllers$ProxySelectorController$retry(){$.ajax({url:makeLink("ProxySwitch"),success:this._onModelReloaded.bind(this),type:"GET",dataType:"JSON"})},_onModelReloaded:function WP$ProxySwitch$Controllers$ProxySelectorController$_onModelReloaded(e){this.modelData=new $$WP.ProxySwitch.Models.ProxySelectorViewModel(e),this._rerender(),this.modelData.Loading&&setTimeout(this.retry.bind(this),5e3)},_rerender:function WP$ProxySwitch$Controllers$ProxySelectorController$_rerender(){this._registerPartialTemplates();var e=$afe.jq(document.activeElement).data("id"),t="true"===this.$menuButton.safeAttr("aria-expanded");this.$switchRoot.find("#proxySubjectList").safeReplaceWith($afe.renderTemplate(this.subjectListTemplate,this.modelData,{})),this.$popupMenu=$afe.select("#proxyList"),1===this.$popupMenu.length&&(this.popupMenuController.destroy(),this.popupMenuController=new $$WP.ProxySwitch.Controllers.ProxyPopupMenuController(this.$popupMenu,this)),t&&(this.openProxyDropdown(),this.popupMenuController.returnFocusToItem(e)),this._onResize(),WP.DOM.Browser.isIE&&$afe.select(".proxySelectorDropDownNameEllipsis").safeAttr("aria-hidden","false"),$afe.select(".roundedPatientPhoto").children("img").on("error",this._onPhotoIconError.bind(this))},_onPhotoIconError:function WP$ProxySwitch$Controllers$ProxySelectorController$_onPhotoIconError(e){if(e&&e.target){var t=$afe.jq(e.target),o=t.data("first-letter");if(o){t.parent().addClass("noBorder");var r=$("<span aria-hidden='true'>"+o+"</span>");t.safeReplaceWith(r)}}},_registerPartialTemplates:function WP$ProxySwitch$Controllers$ProxySelectorController$_registerPartialTemplates(){Handlebars.registerPartial("roundPatientIcon",$$WP.Templates.ProxySwitch.PatientRoundIcon)},_createUploadController:function WP$ProxySwitch$Controllers$ProxySelectorController$_createUploadController(){var e={};e.ViewTemplate=$$WP.Templates.ProxySwitch.DropDownProxySelector;var t=new $$WP.Upload.Models.UploadConfiguration(e);t.ConfigUrl=makeLink("ProxySwitch/ProxyPhotoUpload/GetFileUploadConfiguration"),t.UploadUrl=makeLink("ProxySwitch/ProxyPhotoUpload/UploadFile"),t.ConfirmationViewModel=this.modelData.CurrentlySelected,t.MasterController=this,t.ConfirmFunction=this._findExifAndShowConfirmationPopup,t.RefreshViewOverride=this._updateFileSelector,t.onUploadSuccess=this._refreshPage,t.onUploadFail=this._hideLoading,t.NeedsRedirect=!0,t.RedirectTitle=this.strings.getString("photoUploadUnsavedChangesPopupTitle"),t.RedirectHtml=this.strings.getString("photoUploadUnsavedChangesPopupText"),t.UseGet=!0,t.onConfigSucess=$.proxy(this._hidePhotoUploadIfInvalid,this),t.FromVBPage=!0,this.uploadController=new $$WP.Upload.Controllers.UploadController($afe.select(".patientPhotoListItem"),t)},_hidePhotoUploadIfInvalid:function WP$ProxySwitch$Controllers$ProxySelectorController$_hidePhotoUploadIfInvalid(){(!this.uploadController._settings.AllowedImageAndDocumentExtensions||this.uploadController._settings.AllowedImageAndDocumentExtensions.length<1)&&(this.modelData.resetPhotoUploadToFalse(),this.$switchRoot.empty(),this._render())},_updateFileSelector:function WP$ProxySwitch$Controllers$ProxySelectorController$_updateFileSelector(e){e&&e._settings&&Array.isArray(e._settings.AllowedImageAndDocumentExtensions)&&($afe.select("#patientPhotoFileInput").safeReplaceWith($afe.select("#patientPhotoFileInput")).val("").clone(!0),$afe.select("#patientPhotoFileInput").safeAttr("accept","image/"+e._settings.AllowedImageAndDocumentExtensions.join(",image/")))},_refreshPage:function WP$ProxySwitch$Controllers$ProxySelectorController$_refreshPage(){$$WPUtil.ShowAjaxSpinner($afe.select(".ajaxspinner")),$$WPUtil.TryRedirect(makeLink("inside.asp?mode=HttpModule&State="+self.location.pathname.substring(WP.myPath.length)+encodeURIComponent(self.location.search)+"&RebuildMenu=1"))},_hideLoading:function WP$ProxySwitch$Controllers$ProxySelectorController$_hideLoading(){$$WPUtil.HideAjaxSpinner($afe.select(".defaultajaxoverlay"))},_findExifAndShowConfirmationPopup:function WP$ProxySwitch$Controllers$ProxySelectorController$_findExifAndShowConfirmationPopup(e,t,o,r){var n={};n.viewModel=t,n.successCallback=o,n.uploadController=r,n.inpFile=e,this._getExifTag(e,this._showPhotoConfirmationPopup.bind(this),n)},_showPhotoConfirmationPopup:function WP$ProxySwitch$Controllers$ProxySelectorController$_showPhotoConfirmationPopup(e,t){var o=e.inpFile,r=e.viewModel,n=e.successCallback,i=e.uploadController;t||-1!==o.name.toLowerCase().indexOf(".tif",o.name.length-5)?(formData=new FormData,formData.safeAppend("__file__[]",o),$$WPUtil.ShowAjaxSpinner($afe.select(".defaultajaxoverlay")),$.ajax({dataType:"json",type:"POST",processData:!1,contentType:!1,url:makeLink("ProxySwitch/ProxyPhotoUpload/ConvertToJpegRemoveExif"),data:formData}).done($.proxy((function(e){$$WPUtil.HideAjaxSpinner($afe.select(".defaultajaxoverlay")),this._showPhotoConfirmationCore(!0,o,r,n,i,e.bytes)}),this))):this._showPhotoConfirmationCore(!1,o,r,n,i)},_getExifTag:function WP$ProxySwitch$Controllers$ProxySelectorController$_getExifTag(e,t,o){var r=new FileReader;r.onload=function(e){var r=new DataView(e.target.result);if(65496!=r.getUint16(0))return t(o,!1);for(var n=r.byteLength,i=2;i<n;){if(this._safeGetUint(r,i+2,16,!1)<=8)return t(o,!1);var l=this._safeGetUint(r,i,16,!1);if(i+=2,65505==l){if(1165519206!=this._safeGetUint(r,i+=2,32,!1))return t(o,!1);var s=18761==this._safeGetUint(r,i+=6,16,!1);if(-1===(d=this._safeGetUint(r,i+4,32,s)))break;i+=d;var a=this._safeGetUint(r,i,16,s);i+=2;for(var h=0;h<a;h++)if(274==this._safeGetUint(r,i+12*h,16,s)){var c=this._safeGetUint(r,i+12*h+8,16,s);return t(o,c>=2)}}else{if(65280!=(65280&l))break;var d;if(-1===(d=this._safeGetUint(r,i,16,!1)))break;i+=d}}return t(o,!1)}.bind(this),r.readAsArrayBuffer(e)},_safeGetUint:function WP$ProxySwitch$Controllers$ProxySelectorController$_safeGetUint(e,t,o,r){try{return 16===o?e.getUint16(t,r):e.getUint32(t,r)}catch(e){return-1}},_showPhotoConfirmationCore:function WP$ProxySwitch$Controllers$ProxySelectorController$_showPhotoConfirmationCore(e,t,o,r,n,i){var l;this.strings.addMnemonic("@MYCHART@SUBJECT_PATIENTNAME@",this.modelData.CurrentlySelected.DisplayName),this.strings.addMnemonic("@MYCHART@PHOTO_FILENAME@",t.name,$$WP.Strings.EncodingTypes.None),this.strings.addMnemonic("@MYCHART@ALLOWEDAREAS@",this.modelData.CurrentlySelected.ServiceAreaAbbreviationList,$$WP.Strings.EncodingTypes.None);var s,a=[new $$WPComp.ComplexObjects.Button(this.strings.getString("photoConfirmationPopupAcceptButton"),null,"nextstep","continue"),new $$WPComp.ComplexObjects.Button(this.strings.getString("photoConfirmationPopupCancelButton"),null,"inlinedelete","stop")];this.modelData.CurrentlySelected.IsSelf?(l=this.uploadController._settings.IsPhotoForPatientsChart?"photoUploadConfirmationSelf":"photoUploadConfirmationSelfMyChartOnly",s=this.uploadController._settings.IsPhotoForPatientsChart?"photoUploadScreenReaderConfirmationSelf":"photoUploadScreenReaderConfirmationSelfMyChartOnly"):(l=this.uploadController._settings.IsPhotoForPatientsChart?"photoUploadConfirmationSubject":"photoUploadConfirmationSubjectMyChartOnly",s=this.uploadController._settings.IsPhotoForPatientsChart?"photoUploadScreenReaderConfirmationSubject":"photoUploadScreenReaderConfirmationSubjectMyChartOnly"),this.modelData.CurrentlySelected.ServiceAreaAbbreviationList&&(l+="ServiceAreas",s="ServiceAreas");var h=this.strings.getString(l),c=this.strings.getString(s);this.strings.removeMnemonic("@MYCHART@SUBJECT_PATIENTNAME@"),this.strings.removeMnemonic("@MYCHART@PHOTO_FILENAME@"),this.strings.removeMnemonic("@MYCHART@ALLOWEDAREAS@"),h="<span id='proxyPhotoPreview' class='largePhoto'></span>  <span class='clearlabel'>"+c+"</span><span aria-hidden='true'>"+h+"</span> ";var d=this.strings.getString("UploadingPhoto"),p=URL.createObjectURL(t);if(o.PhotoUrl=p,$$WPUtil.quickMessageBox(h,this.strings.getString("uploadPhotoTitle"),a,(function(e,t,o,r,n,i){URL.revokeObjectURL(r),"toolbarcontinue"===i&&($$WPUtil.ShowAjaxSpinner($afe.select(".defaultajaxoverlay")),t.call(e,o))}),[n,r,t,p,d],"photoUploadConfirmationComponent"),e){var P=new Blob([new Uint8Array(i)],{type:"image/jpeg"});p=URL.createObjectURL(P);o.PhotoUrl=p}return $afe.select("#proxyPhotoPreview").safeAppend($afe.renderTemplate($$WP.Templates.ProxySwitch.PatientRoundIcon,o)),$afe.select("#proxyPhotoPreview").safeAttr("aria-label",t.name),this._updateFileSelector(this.uploadController),!0},_handleKeydown:function WP$ProxySwitch$Controllers$ProxySelectorController$_handleKeydown(e){var t=!1;switch(e.keyCode){case this.keyCode.SPACE:case this.keyCode.RETURN:this.popupMenuController&&(this.openProxyDropdown(),this.popupMenuController.setFocusToFirstItem()),t=!0;break;case this.keyCode.ESC:this.popupMenuController&&"true"===this.$menuButton.safeAttr("aria-expanded")&&(this.closeProxyDropdown(),t=!0)}t&&(e.stopPropagation(),e.preventDefault())},_handleClick:function WP$ProxySwitch$Controllers$ProxySelectorController$_handleClick(e){this.dontReopen&&(this.dontReopen=!1),"true"===this.$menuButton.safeAttr("aria-expanded")?this.closeProxyDropdown():(this.openProxyDropdown(),this.popupMenuController.setFocusToFirstItem())},openProxyDropdown:function WP$ProxySwitch$Controllers$ProxySelectorController$openProxyDropdown(){if(!((new Date).getTime()-this.lastCloseTime<250)){this._onResize(),this.$switchRoot.addClass("show-menu"),this.$menuButton.safeAttr("aria-expanded","true"),$afe.select(".proxyMenuShield").fadeIn("fast"),this.__setAriaHiddenForPage(!0);var e=$afe.select("body");window.innerWidth>1024&&e.css("margin-top",-$$WPUtil.getScrollTop());var t=e.css("position");$$WP.Utilities.UI.ToggleBodyScrolling(!0),e.css("position",t),$afe.select(".dropDownProxyList")[0].scrollTop=0}},closeProxyDropdown:function WP$ProxySwitch$Controllers$ProxySelectorController$closeProxyDropdown(){this.$switchRoot.removeClass("show-menu"),this.$menuButton.safeAttr("aria-expanded","false");var e=$afe.select("body"),t=-parseInt(e.css("margin-top"));$afe.select(".proxyMenuShield").fadeOut("fast"),$$WP.Utilities.UI.ToggleBodyScrolling(!1),window.innerWidth>1024&&(e.css("margin-top",""),$$WPUtil.setScrollTop(t)),this.lastCloseTime=(new Date).getTime(),this.__setAriaHiddenForPage(!1),e.css("position","")},__setAriaHiddenForPage:function WP$ProxySwitch$Controllers$ProxySelectorController$__setAriaHiddenForPage(e){$afe.select("#footer").safeAttr("aria-hidden",e),$afe.select("#content").safeAttr("aria-hidden",e),$afe.select("#toastWrapper").safeAttr("aria-hidden",e)}};var t={ControllerObject:null,Constructor:e,getProxySelectorController:function(e){return this.ControllerObject||(this.ControllerObject=new this.Constructor(e)),this.ControllerObject}};$$WP.ProxySwitch.Controllers.ProxySelectorController=t,e.extend($$WP.Controllers.Controller,"WP$ProxySwitch$Controllers$ProxySelectorController")}();